var IssuesAPI={requestIssuesAPI(s,e,i){var t=10;!function a(){return new Promise(((r,n)=>{var o=0,l=setTimeout((()=>{0===o&&(o=2,l=null,n("请求超时"),0==t&&i())}),5e3);fetch(s).then((function(s){if(2!==o&&(clearTimeout(l),r(s),l=null,o=1),s.ok)return s.json();throw new Error("Network response was not ok.")})).then((function(s){t=0,e(s)})).catch((function(s){t>0?(t-=1,setTimeout((()=>{a()}),5e3)):i()}))}))}()},parseIssueStrToJson(s){var e=s.match(/```json[\s|\S]*```/);if(e&&e.length>0&&(e=e[0]),e&&(e=e.split("```json")[1].split("```")[0]))return JSON.parse(e)},groupIssuesData(s,e){var t=new Object;if(e.length>0)if(null!=s.group){if((p=s.group.split(":")).length>1){var a=p[0],r=p[1];for(a&&r&&(r=r.split(",")),s.group=r,i=0;i<e.length;i++){if((l=this.parseIssueStrToJson(e[i].body))&&a in l){var n=l[a];n=n.replace(", ",",").split(",");for(var o=0;o<n.length;o++){if(r.includes(n[o]))null==(p=t[n[o]])&&(p=new Array),p.push(l),t[n[o]]=p}}}}}else for(s.group=[""],i=0;i<e.length;i++){var l,p;if(l=this.parseIssueStrToJson(e[i].body))null==(p=t[""])&&(p=new Array),p.push(l),t[""]=p}return t},getIssuesAPIForSites(s){var e=$(s.el)[0];$(e).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(s.api,(function(i){$(e).find(".loading").remove();var t=IssuesAPI.groupIssuesData(s,i),a=Object.keys(t);s.group.forEach(((s,i)=>{var r=t[s];if(r&&r.length>0)for(s.length>0?$(e).append("<h2>"+s+"</h2>"):""==name&&a.length>1&&$(e).append("<h2>未分组</h2>"),$(e).append('<div class="site-card-group '+i+'"></div>'),j=0;j<r.length;j++){var n=r[j],o="";o=n.screenshot&&n.screenshot.length>0?'<div class="img"><img src="'+n.screenshot+'" onerror="javascript:this.src=\'https://image.thum.io/get/width/1024/crop/768/'+n.url+"';\"/></div>":'<div class="img"></div>';var l='<div class="info">';n.avatar&&n.avatar.length>0&&(l+='<img src="'+n.avatar+'" onerror="javascript:this.src=\'https://image.thum.io/get/width/1024/crop/768/'+n.url+"';\"/>"),l+='<span class="title">'+n.title+'</span><span class="desc">'+n.description+"</span></div>";var p="<a class='site-card' target='_blank' href='"+n.url+"'>"+o+l+"</a>";$(e).find(".site-card-group."+i).append(p)}}))}),(function(){$(e).find(".loading i").remove(),$(e).find(".loading p").text("加载失败，请稍后重试。")}))},getIssuesAPIForTimeline(s){var e=$(s.el)[0];$(e).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(s.api,(function(s){if($(e).find(".loading").remove(),s.length>0)for(i=0;i<s.length;i++){var t='&nbsp;&nbsp;<a class="comments" target="_blank" href="'+s[i].html_url+'"><i class="fa fa-comment-dots fa-fw"></i>'+s[i].comments+"</a>",a='<div class="timenode">'+('<div class="meta"><p></p><p>'+s[i].title+t+"</p><p></p></div>")+('<div class="body"><p>'+s[i].body+"</p></div>")+"</div>";$(e).append(a)}}),(function(){$(e).find(".loading i").remove(),$(e).find(".loading p").text("加载失败，请稍后重试。")}))},request(){for(var s=document.getElementsByClassName("issues-api"),e=0;e<s.length;e++){var i=s[e],t=i.getAttribute("api"),a=i.getAttribute("group"),r=new Object;r.class=i.getAttribute("class"),r.el=i,r.api=t,r.group=a,r.class.split(" ").includes("sites")?this.getIssuesAPIForSites(r):r.class.split(" ").includes("timeline")&&this.getIssuesAPIForTimeline(r)}}};IssuesAPI.request(),document.addEventListener("pjax:compvare",(function(){IssuesAPI.request()}));